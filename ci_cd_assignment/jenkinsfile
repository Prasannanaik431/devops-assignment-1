pipeline {
  agent any
  environment {
    REGISTRY = "docker.io"
    IMAGE = "${env.REGISTRY}/myorg/myapp:${env.GIT_COMMIT}"
  }
  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }
    stage('Lint') {
      steps {
        sh 'pip install flake8'
        sh 'flake8 || true'
      }
    }
    stage('Test') {
      steps {
        sh 'pip install -r requirements.txt'
        sh 'pytest --junitxml=report.xml'
        junit 'report.xml'
      }
    }
    stage('Build') {
      steps {
        sh 'docker build -t $IMAGE .'
      }
    }
    stage('Security Scan') {
      steps {
        // run trivy or another scanner
        sh 'trivy image --severity HIGH,CRITICAL $IMAGE || true'
      }
    }
    stage('Push') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
          sh 'echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin'
          sh 'docker push $IMAGE'
        }
      }
    }
    stage('Deploy Staging') {
      steps {
        // Example kubectl deploy
        withCredentials([file(credentialsId: 'kubeconfig-staging', variable: 'KUBECONFIG_FILE')]) {
          sh 'kubectl --kubeconfig=$KUBECONFIG_FILE set image deployment/myapp myapp=$IMAGE'
          sh 'kubectl --kubeconfig=$KUBECONFIG_FILE rollout status deployment/myapp'
        }
      }
    }
    stage('Approval') {
      steps {
        input message: 'Approve production deployment?', ok: 'Deploy'
      }
    }
    stage('Deploy Production') {
      steps {
        withCredentials([file(credentialsId: 'kubeconfig-prod', variable: 'KUBECONFIG_FILE')]) {
          sh 'kubectl --kubeconfig=$KUBECONFIG_FILE set image deployment/myapp myapp=$IMAGE'
          sh 'kubectl --kubeconfig=$KUBECONFIG_FILE rollout status deployment/myapp'
        }
      }
    }
  }
  post {
    failure {
      mail to: 'oncall@example.com',
           subject: "Build failed in Jenkins: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
           body: "See console output at ${env.BUILD_URL}"
    }
  }
}
