# Architecture Documentation

## System Architecture Diagram

```
                                    ┌──────────────────────────────────────────────────────────────┐
                                    │                        EXTERNAL                              │
                                    │                                                              │
                                    │   ┌─────────────┐         ┌─────────────────────────────┐   │
                                    │   │  Developer  │         │        End Users             │   │
                                    │   │   (Push)    │         │       (HTTP Traffic)         │   │
                                    │   └──────┬──────┘         └─────────────┬───────────────┘   │
                                    │          │                              │                    │
                                    └──────────┼──────────────────────────────┼────────────────────┘
                                               │                              │
                                               ▼                              ▼
┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                          CI/CD LAYER                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                     GitHub Actions Pipeline                                              │ │
│  │  ┌───────────┐    ┌───────────┐    ┌───────────┐    ┌───────────┐    ┌───────────┐    ┌───────────┐    │ │
│  │  │  Checkout │───▶│  Quality  │───▶│   Build   │───▶│  Security │───▶│   Push    │───▶│  Deploy   │    │ │
│  │  │           │    │   Check   │    │   Image   │    │   Scan    │    │   GHCR    │    │   K8s     │    │ │
│  │  └───────────┘    └───────────┘    └───────────┘    └───────────┘    └───────────┘    └───────────┘    │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                       INFRASTRUCTURE LAYER                                                    │
│                                                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                    Kubernetes Cluster (kubeadm)                                          │ │
│  │                                                                                                          │ │
│  │  ┌────────────────────────────────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                              Control Plane Node (VM 1)                                              │ │ │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │ │ │
│  │  │  │  API Server  │  │  Controller  │  │  Scheduler   │  │     etcd     │  │   Calico     │          │ │ │
│  │  │  │              │  │   Manager    │  │              │  │              │  │    CNI       │          │ │ │
│  │  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘          │ │ │
│  │  └────────────────────────────────────────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                                                          │ │
│  │  ┌───────────────────────────────────────────┐  ┌───────────────────────────────────────────┐          │ │
│  │  │           Worker Node (VM 2)               │  │           Worker Node (VM 3)               │          │ │
│  │  │  ┌─────────────┐  ┌─────────────┐         │  │  ┌─────────────┐  ┌─────────────┐         │          │ │
│  │  │  │   kubelet   │  │  containerd │         │  │  │   kubelet   │  │  containerd │         │          │ │
│  │  │  └─────────────┘  └─────────────┘         │  │  └─────────────┘  └─────────────┘         │          │ │
│  │  │  ┌─────────────────────────────────────┐  │  │  ┌─────────────────────────────────────┐  │          │ │
│  │  │  │           Application Pods          │  │  │  │           Application Pods          │  │          │ │
│  │  │  │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐   │  │  │  │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐   │  │          │ │
│  │  │  │  │ dev │ │stage│ │prod │ │ ... │   │  │  │  │  │ dev │ │stage│ │prod │ │ ... │   │  │          │ │
│  │  │  │  └─────┘ └─────┘ └─────┘ └─────┘   │  │  │  │  └─────┘ └─────┘ └─────┘ └─────┘   │  │          │ │
│  │  │  └─────────────────────────────────────┘  │  │  └─────────────────────────────────────┘  │          │ │
│  │  └───────────────────────────────────────────┘  └───────────────────────────────────────────┘          │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                         NETWORKING LAYER                                                      │
│                                                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                      Envoy Gateway (L7 Load Balancer)                                    │ │
│  │                                                                                                          │ │
│  │   External Traffic ────▶ ┌──────────────────────────────────────────────────────────────────────┐       │ │
│  │                          │                         Gateway                                       │       │ │
│  │                          │  ┌──────────────────────────────────────────────────────────────┐    │       │ │
│  │                          │  │                    HTTP Listeners (:80)                      │    │       │ │
│  │                          │  └──────────────────────────────────────────────────────────────┘    │       │ │
│  │                          └──────────────────────────────────────────────────────────────────────┘       │ │
│  │                                               │                                                          │ │
│  │                          ┌────────────────────┼────────────────────┐                                    │ │
│  │                          ▼                    ▼                    ▼                                    │ │
│  │                   ┌─────────────┐      ┌─────────────┐      ┌─────────────┐                             │ │
│  │                   │  HTTPRoute  │      │  HTTPRoute  │      │  HTTPRoute  │                             │ │
│  │                   │    (dev)    │      │   (stage)   │      │   (prod)    │                             │ │
│  │                   └──────┬──────┘      └──────┬──────┘      └──────┬──────┘                             │ │
│  │                          ▼                    ▼                    ▼                                    │ │
│  │                   ┌─────────────┐      ┌─────────────┐      ┌─────────────┐                             │ │
│  │                   │   Service   │      │   Service   │      │   Service   │                             │ │
│  │                   │ (ClusterIP) │      │ (ClusterIP) │      │ (ClusterIP) │                             │ │
│  │                   └──────┬──────┘      └──────┬──────┘      └──────┬──────┘                             │ │
│  │                          ▼                    ▼                    ▼                                    │ │
│  │                   ┌─────────────┐      ┌─────────────┐      ┌─────────────┐                             │ │
│  │                   │   Pod(s)    │      │   Pod(s)    │      │   Pod(s)    │                             │ │
│  │                   │   x1        │      │   x2        │      │   x3-10     │                             │ │
│  │                   │  (64Mi)     │      │  (128Mi)    │      │  (256Mi)    │                             │ │
│  │                   └─────────────┘      └─────────────┘      └─────────────┘                             │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                         OBSERVABILITY LAYER                                                   │
│                                                                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                         Prometheus Stack                                                  │ │
│  │                                                                                                          │ │
│  │  ┌──────────────────┐       ┌──────────────────┐       ┌──────────────────┐                             │ │
│  │  │    Prometheus    │◀──────│   Kubernetes     │       │    Node Port     │                             │ │
│  │  │     Server       │       │   Service Disc.  │       │     :30090       │─────▶ Admin Access          │ │
│  │  │                  │       │                  │       │                  │                             │ │
│  │  └────────┬─────────┘       └──────────────────┘       └──────────────────┘                             │ │
│  │           │                                                                                              │ │
│  │           │    Scrapes metrics from:                                                                     │ │
│  │           │    • Kubernetes API Server                                                                   │ │
│  │           │    • Node metrics                                                                            │ │
│  │           │    • Pod metrics (with prometheus.io/scrape annotation)                                      │ │
│  │           │    • FastAPI pods (dev, stage, prod)                                                         │ │
│  │           │                                                                                              │ │
│  │           ▼                                                                                              │ │
│  │  ┌──────────────────────────────────────────────────────────────────────────────────────────────────┐   │ │
│  │  │                                    Metrics Storage (TSDB)                                         │   │ │
│  │  │  • cluster_health    • pod_cpu_usage    • pod_memory_usage    • http_requests    • uptime        │   │ │
│  │  └──────────────────────────────────────────────────────────────────────────────────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Scalability Design

### Horizontal Pod Autoscaling (HPA)

```
                                 HORIZONTAL SCALING FLOW
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                          │
│                                         Traffic Load                                                     │
│                                              │                                                           │
│                                              ▼                                                           │
│   ┌──────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                    Metrics Server                                                 │  │
│   │                            Collects: CPU, Memory usage                                           │  │
│   └──────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                              │                                                           │
│                                              ▼                                                           │
│   ┌──────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                           Horizontal Pod Autoscaler (HPA)                                         │  │
│   │                                                                                                    │  │
│   │   Rules:                                                                                           │  │
│   │   • Target CPU Utilization: 70%                                                                   │  │
│   │   • Target Memory Utilization: 80%                                                                │  │
│   │   • Min Replicas: 3                                                                               │  │
│   │   • Max Replicas: 10                                                                              │  │
│   │                                                                                                    │  │
│   │   Scale Up Behavior:                                                                              │  │
│   │   • Stabilization: 0s (immediate)                                                                 │  │
│   │   • Max increase: 100% or 4 pods per 15s                                                          │  │
│   │                                                                                                    │  │
│   │   Scale Down Behavior:                                                                            │  │
│   │   • Stabilization: 300s (5 min cooldown)                                                          │  │
│   │   • Max decrease: 25% per 60s                                                                     │  │
│   └──────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                              │                                                           │
│                           ┌──────────────────┴──────────────────┐                                       │
│                           ▼                                      ▼                                       │
│   ┌───────────────────────────────────────┐  ┌───────────────────────────────────────┐                  │
│   │          LOW TRAFFIC STATE            │  │          HIGH TRAFFIC STATE           │                  │
│   │                                        │  │                                        │                  │
│   │   ┌─────┐ ┌─────┐ ┌─────┐             │  │   ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐    │                  │
│   │   │ Pod │ │ Pod │ │ Pod │             │  │   │ Pod │ │ Pod │ │ Pod │ │ Pod │    │                  │
│   │   │  1  │ │  2  │ │  3  │             │  │   │  1  │ │  2  │ │  3  │ │  4  │    │                  │
│   │   └─────┘ └─────┘ └─────┘             │  │   └─────┘ └─────┘ └─────┘ └─────┘    │                  │
│   │                                        │  │   ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐    │                  │
│   │   CPU: ~30% | Memory: ~40%            │  │   │ Pod │ │ Pod │ │ Pod │ │ Pod │    │                  │
│   │                                        │  │   │  5  │ │  6  │ │  7  │ │  8  │    │                  │
│   │   3 Replicas (minimum)                │  │   └─────┘ └─────┘ └─────┘ └─────┘    │                  │
│   │                                        │  │                                        │                  │
│   └───────────────────────────────────────┘  │   CPU: ~75% | Memory: ~60%            │                  │
│                                               │                                        │                  │
│                                               │   8 Replicas (scaled up)              │                  │
│                                               └───────────────────────────────────────┘                  │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### Vertical Scaling Strategy

```
                                 VERTICAL SCALING FLOW
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                          │
│   STEP 1: Identify Resource Constraints                                                                 │
│   ┌──────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │   Prometheus Query: container_memory_usage_bytes > limits                                        │  │
│   │   Alert: "Pod memory hitting limits, consider vertical scaling"                                  │  │
│   └──────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                              │                                                           │
│                                              ▼                                                           │
│   STEP 2: Update Infrastructure (OpenTofu)                                                              │
│   ┌──────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                                    │  │
│   │   Before                                     After                                                 │  │
│   │   ┌─────────────────────────┐               ┌─────────────────────────┐                           │  │
│   │   │ variable "vm_cpu_cores" │               │ variable "vm_cpu_cores" │                           │  │
│   │   │   default = 2           │  ───────▶     │   default = 4           │                           │  │
│   │   │ variable "vm_memory_gb" │               │ variable "vm_memory_gb" │                           │  │
│   │   │   default = 4           │               │   default = 8           │                           │  │
│   │   └─────────────────────────┘               └─────────────────────────┘                           │  │
│   │                                                                                                    │  │
│   │   Cloud Provider: Resize VMs (requires brief downtime per node)                                   │  │
│   └──────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                              │                                                           │
│                                              ▼                                                           │
│   STEP 3: Update Pod Resource Limits                                                                    │
│   ┌──────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                                                                                    │  │
│   │   # k8s/overlays/prod/kustomization.yaml                                                          │  │
│   │                                                                                                    │  │
│   │   Before                                     After                                                 │  │
│   │   ┌─────────────────────────┐               ┌─────────────────────────┐                           │  │
│   │   │ resources:               │               │ resources:               │                           │  │
│   │   │   requests:              │  ───────▶     │   requests:              │                           │  │
│   │   │     memory: "256Mi"      │               │     memory: "512Mi"      │                           │  │
│   │   │     cpu: "200m"          │               │     cpu: "500m"          │                           │  │
│   │   │   limits:                │               │   limits:                │                           │  │
│   │   │     memory: "512Mi"      │               │     memory: "1Gi"        │                           │  │
│   │   │     cpu: "1000m"         │               │     cpu: "2000m"         │                           │  │
│   │   └─────────────────────────┘               └─────────────────────────┘                           │  │
│   │                                                                                                    │  │
│   └──────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                              │                                                           │
│                                              ▼                                                           │
│   STEP 4: Rolling Update                                                                                │
│   ┌──────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │   kubectl apply -k k8s/overlays/prod/                                                             │  │
│   │   kubectl rollout status deployment/prod-fastapi -n prod                                          │  │
│   └──────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Multi-Environment Namespace Isolation

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    NAMESPACE ISOLATION                                                   │
│                                                                                                          │
│   ┌───────────────────────────────────────────────────────────────────────────────────────────────────┐ │
│   │                                    Kubernetes Cluster                                              │ │
│   │                                                                                                    │ │
│   │   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │ │
│   │   │                              System Namespaces                                               │ │ │
│   │   │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │ │ │
│   │   │   │   kube-system   │  │  kube-public    │  │ envoy-gateway-  │  │   monitoring    │        │ │ │
│   │   │   │                 │  │                 │  │     system      │  │                 │        │ │ │
│   │   │   │ • CoreDNS       │  │ • Cluster info  │  │ • Gateway       │  │ • Prometheus    │        │ │ │
│   │   │   │ • kube-proxy    │  │                 │  │ • GatewayClass  │  │ • Alertmanager  │        │ │ │
│   │   │   │ • Calico        │  │                 │  │ • Envoy         │  │                 │        │ │ │
│   │   │   └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘        │ │ │
│   │   └─────────────────────────────────────────────────────────────────────────────────────────────┘ │ │
│   │                                                                                                    │ │
│   │   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │ │
│   │   │                              Application Namespaces                                          │ │ │
│   │   │                                                                                              │ │ │
│   │   │   ┌───────────────────────────────────────────────────────────────────────────────────────┐ │ │ │
│   │   │   │                                    DEV                                                 │ │ │ │
│   │   │   │   Namespace: dev                                                                       │ │ │ │
│   │   │   │   ┌───────────────┐ ┌───────────────┐ ┌───────────────┐                               │ │ │ │
│   │   │   │   │  Deployment   │ │    Service    │ │   HTTPRoute   │                               │ │ │ │
│   │   │   │   │ dev-fastapi   │ │ dev-fastapi   │ │dev-fastapi-   │                               │ │ │ │
│   │   │   │   │ replicas: 1   │ │   :8000       │ │    route      │                               │ │ │ │
│   │   │   │   └───────────────┘ └───────────────┘ └───────────────┘                               │ │ │ │
│   │   │   │   Resources: 64Mi/50m → 128Mi/250m                                                    │ │ │ │
│   │   │   │   Branch: dev                                                                          │ │ │ │
│   │   │   └───────────────────────────────────────────────────────────────────────────────────────┘ │ │ │
│   │   │                                                                                              │ │ │
│   │   │   ┌───────────────────────────────────────────────────────────────────────────────────────┐ │ │ │
│   │   │   │                                   STAGE                                                │ │ │ │
│   │   │   │   Namespace: stage                                                                     │ │ │ │
│   │   │   │   ┌───────────────┐ ┌───────────────┐ ┌───────────────┐                               │ │ │ │
│   │   │   │   │  Deployment   │ │    Service    │ │   HTTPRoute   │                               │ │ │ │
│   │   │   │   │stage-fastapi  │ │stage-fastapi  │ │stage-fastapi- │                               │ │ │ │
│   │   │   │   │ replicas: 2   │ │   :8000       │ │    route      │                               │ │ │ │
│   │   │   │   └───────────────┘ └───────────────┘ └───────────────┘                               │ │ │ │
│   │   │   │   Resources: 128Mi/100m → 256Mi/500m                                                  │ │ │ │
│   │   │   │   Branch: stage                                                                        │ │ │ │
│   │   │   └───────────────────────────────────────────────────────────────────────────────────────┘ │ │ │
│   │   │                                                                                              │ │ │
│   │   │   ┌───────────────────────────────────────────────────────────────────────────────────────┐ │ │ │
│   │   │   │                                   PROD                                                 │ │ │ │
│   │   │   │   Namespace: prod                                                                      │ │ │ │
│   │   │   │   ┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐             │ │ │ │
│   │   │   │   │  Deployment   │ │    Service    │ │   HTTPRoute   │ │      HPA      │             │ │ │ │
│   │   │   │   │ prod-fastapi  │ │ prod-fastapi  │ │prod-fastapi-  │ │  3-10 pods    │             │ │ │ │
│   │   │   │   │ replicas: 3+  │ │   :8000       │ │    route      │ │  CPU: 70%     │             │ │ │ │
│   │   │   │   └───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘             │ │ │ │
│   │   │   │   Resources: 256Mi/200m → 512Mi/1000m                                                 │ │ │ │
│   │   │   │   Branch: main                                                                         │ │ │ │
│   │   │   └───────────────────────────────────────────────────────────────────────────────────────┘ │ │ │
│   │   │                                                                                              │ │ │
│   │   └─────────────────────────────────────────────────────────────────────────────────────────────┘ │ │
│   │                                                                                                    │ │
│   └───────────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Request Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                       REQUEST FLOW                                                       │
│                                                                                                          │
│   ┌─────────┐                                                                                           │
│   │  User   │                                                                                           │
│   │ Request │                                                                                           │
│   └────┬────┘                                                                                           │
│        │                                                                                                │
│        │ HTTP GET /                                                                                     │
│        ▼                                                                                                │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                    Node Port / LoadBalancer                                      │  │
│   │                                         (Port 80)                                                │  │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│        │                                                                                                │
│        ▼                                                                                                │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                      Envoy Gateway                                               │  │
│   │                                                                                                   │  │
│   │   1. Receives incoming HTTP request                                                              │  │
│   │   2. Matches HTTPRoute rules                                                                     │  │
│   │   3. Selects target Service based on path/host                                                   │  │
│   │   4. Load balances across healthy pod endpoints                                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│        │                                                                                                │
│        ▼                                                                                                │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                    Kubernetes Service                                            │  │
│   │                                      (ClusterIP)                                                 │  │
│   │                                                                                                   │  │
│   │   Provides stable endpoint for pod discovery                                                     │  │
│   │   Selector: app=fastapi                                                                          │  │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│        │                                                                                                │
│        │ Round-robin to healthy pods                                                                   │
│        ▼                                                                                                │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                     FastAPI Pod                                                  │  │
│   │                                                                                                   │  │
│   │   ┌───────────────────────────────────────────────────────────────────────────────────────────┐ │  │
│   │   │                                  Container                                                 │ │  │
│   │   │                                                                                            │ │  │
│   │   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                                   │ │  │
│   │   │   │   Uvicorn   │───▶│   FastAPI   │───▶│  Response   │                                   │ │  │
│   │   │   │  (ASGI)     │    │   Handler   │    │   JSON      │                                   │ │  │
│   │   │   │  :8000      │    │   /         │    │  {"status"  │                                   │ │  │
│   │   │   │             │    │             │    │   "ok"...}  │                                   │ │  │
│   │   │   └─────────────┘    └─────────────┘    └─────────────┘                                   │ │  │
│   │   │                                                                                            │ │  │
│   │   └───────────────────────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                                                                                   │  │
│   │   Health Checks:                                                                                 │  │
│   │   • Liveness:  GET / every 10s                                                                   │  │
│   │   • Readiness: GET / every 5s                                                                    │  │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│        │                                                                                                │
│        │ Response: {"status": "ok", "message": "Hello World", "timestamp": "..."}                      │
│        ▼                                                                                                │
│   ┌─────────┐                                                                                           │
│   │  User   │                                                                                           │
│   │Response │                                                                                           │
│   └─────────┘                                                                                           │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## CI/CD Pipeline Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                      CI/CD PIPELINE FLOW                                                 │
│                                                                                                          │
│   ┌─────────┐                                                                                           │
│   │   Git   │                                                                                           │
│   │  Push   │                                                                                           │
│   └────┬────┘                                                                                           │
│        │                                                                                                │
│        │ Trigger: push to dev/stage/main                                                               │
│        ▼                                                                                                │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                    STAGE 1: CODE QUALITY                                         │  │
│   │                                                                                                   │  │
│   │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                                          │  │
│   │   │   flake8    │    │    black    │    │   isort     │                                          │  │
│   │   │  (linting)  │    │ (formatting)│    │  (imports)  │                                          │  │
│   │   └──────┬──────┘    └──────┬──────┘    └──────┬──────┘                                          │  │
│   │          │                  │                  │                                                  │  │
│   │          └──────────────────┼──────────────────┘                                                  │  │
│   │                             ▼                                                                     │  │
│   │                      ┌─────────────┐                                                              │  │
│   │                      │   Pass/Fail │                                                              │  │
│   │                      └─────────────┘                                                              │  │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│        │                                                                                                │
│        ▼                                                                                                │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                    STAGE 2: BUILD                                                │  │
│   │                                                                                                   │  │
│   │   ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │  │
│   │   │                             Docker Build                                                 │   │  │
│   │   │                                                                                          │   │  │
│   │   │   FROM python:3.10-slim                                                                  │   │  │
│   │   │   COPY requirements.txt .                                                                │   │  │
│   │   │   RUN pip install -r requirements.txt                                                    │   │  │
│   │   │   COPY app app                                                                           │   │  │
│   │   │   CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]                │   │  │
│   │   │                                                                                          │   │  │
│   │   └─────────────────────────────────────────────────────────────────────────────────────────┘   │  │
│   │                             │                                                                    │  │
│   │                             ▼                                                                    │  │
│   │   ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │  │
│   │   │                      Push to GitHub Container Registry                                   │   │  │
│   │   │                                                                                          │   │  │
│   │   │   Tags:                                                                                  │   │  │
│   │   │   • ghcr.io/repo/fastapi:<commit-sha>                                                   │   │  │
│   │   │   • ghcr.io/repo/fastapi:<branch>                                                       │   │  │
│   │   │   • ghcr.io/repo/fastapi:latest (main only)                                             │   │  │
│   │   │                                                                                          │   │  │
│   │   └─────────────────────────────────────────────────────────────────────────────────────────┘   │  │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│        │                                                                                                │
│        ▼                                                                                                │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                    STAGE 3: SECURITY SCAN                                        │  │
│   │                                                                                                   │  │
│   │   ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │  │
│   │   │                              Trivy Scanner                                               │   │  │
│   │   │                                                                                          │   │  │
│   │   │   ┌─────────────────────┐    ┌─────────────────────┐                                    │   │  │
│   │   │   │   Container Scan    │    │   Filesystem Scan   │                                    │   │  │
│   │   │   │                     │    │                     │                                    │   │  │
│   │   │   │ • OS packages       │    │ • Python deps       │                                    │   │  │
│   │   │   │ • Application libs  │    │ • requirements.txt  │                                    │   │  │
│   │   │   │                     │    │                     │                                    │   │  │
│   │   │   └─────────────────────┘    └─────────────────────┘                                    │   │  │
│   │   │                                                                                          │   │  │
│   │   │   Output: SARIF report uploaded to GitHub Security                                      │   │  │
│   │   └─────────────────────────────────────────────────────────────────────────────────────────┘   │  │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│        │                                                                                                │
│        ▼                                                                                                │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                    STAGE 4: DEPLOY                                               │  │
│   │                                                                                                   │  │
│   │   ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │  │
│   │   │   Branch Mapping                                                                         │   │  │
│   │   │                                                                                          │   │  │
│   │   │   dev   ────────▶ kubectl apply -k k8s/overlays/dev/   ────────▶ namespace: dev         │   │  │
│   │   │   stage ────────▶ kubectl apply -k k8s/overlays/stage/ ────────▶ namespace: stage       │   │  │
│   │   │   main  ────────▶ kubectl apply -k k8s/overlays/prod/  ────────▶ namespace: prod        │   │  │
│   │   │                                                                                          │   │  │
│   │   └─────────────────────────────────────────────────────────────────────────────────────────┘   │  │
│   │                             │                                                                    │  │
│   │                             ▼                                                                    │  │
│   │   ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │  │
│   │   │   Rollout Verification                                                                   │   │  │
│   │   │                                                                                          │   │  │
│   │   │   • kubectl rollout status deployment/<env>-fastapi -n <namespace>                      │   │  │
│   │   │   • Verify pods are running                                                              │   │  │
│   │   │   • Health check endpoint test                                                           │   │  │
│   │   │                                                                                          │   │  │
│   │   └─────────────────────────────────────────────────────────────────────────────────────────┘   │  │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│        │                                                                                                │
│        ▼                                                                                                │
│   ┌─────────────┐                                                                                       │
│   │  Deployed!  │                                                                                       │
│   └─────────────┘                                                                                       │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```



